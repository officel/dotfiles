# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

includes:
  aqua:
    taskfile: aqua/Taskfile.yml
    optional: true
    internal: false
    flatten: false
    aliases:
      - a

vars:
  USER_HOME: "~"                # ユーザーホーム（テンプレでパスとして使うので/をつけない）
  XDG_CONFIG_HOME: "~/.config"  # XDG_CONFIG_HOME 環境変数のデフォルト値

tasks:
  default:
    cmds:
      - echo "This is {{.TASKFILE}} at v{{.TASK_VERSION}}"
      - task --list --sort alphanumeric -t {{.TASKFILE}}
    silent: true

  link:
    desc: "Create symlinks for configuration files"
    cmds:
      - mkdir -p {{.XDG_CONFIG_HOME}}
      # USER_HOME にシンボリックリンクを作成[TARGET,LINK_NAME]
      - for:
          - "direnvrc,.direnvrc"
        task: _link
        vars:
          TARGET: "{{.TASKFILE_DIR}}/{{index (.ITEM | splitList \",\") 0}}"
          LINK_NAME: "{{.USER_HOME}}/{{index (.ITEM | splitList \",\") 1}}"
      # XDG_CONFIG_HOME にシンボリックリンクを同名のディレクトリで作成
      - for:
          - "aqua"
          - "bash"
          - "git"
          - "task"
        task: _link
        vars:
          TARGET: "{{.TASKFILE_DIR}}/{{.ITEM}}"
          LINK_NAME: "{{.XDG_CONFIG_HOME}}/{{.ITEM}}"
    silent: true

  _link:
    desc: "Helper task to create a symlink"
    vars:
      TARGET: "{{.TARGET}}"
      LINK_NAME: "{{.LINK_NAME}}"
    cmds:
      - ln -s -b --suffix=.bak {{.TARGET}} {{.LINK_NAME}}
      - if test {{.LINK_NAME}} -ef {{.LINK_NAME}}.bak ; then rm {{.LINK_NAME}}.bak ; fi
      - ls -l {{.LINK_NAME}}*
      # バックアップをとりつつ、同じリンク先ならバックアップは不要なので削除している
    silent: true
    internal: true
